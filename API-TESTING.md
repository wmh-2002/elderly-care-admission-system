# 🏥 养老院管理系统 API 测试指南

## 📋 概述

本项目提供了完整的API测试脚本 `test-complete-api.sh`，用于测试养老院管理系统的所有接口功能。

## 🚀 快速开始

### 1. 环境准备

确保以下条件满足：
- ✅ MySQL服务正在运行
- ✅ 数据库 `nms` 已创建
- ✅ 后端服务已启动 (`mvn spring-boot:run`)
- ✅ 服务器运行在 `http://localhost:8080`

### 2. 运行测试

```bash
# 方式1：运行完整测试套件
./test-complete-api.sh

# 方式2：运行用户API专项测试
./test-user-apis.sh

# 方式3：运行角色API专项测试
./test-role-apis.sh

# 方式4：运行房间API专项测试
./test-room-apis.sh

# 方式5：运行床位API专项测试
./test-bed-apis.sh

# 方式6：运行护理等级API专项测试
./test-care-level-apis.sh

# 方式7：运行老人档案API专项测试
./test-elder-apis.sh

# 方式8：指定服务器地址
BASE_URL=http://your-server:port ./test-complete-api.sh
BASE_URL=http://your-server:port ./test-user-apis.sh
BASE_URL=http://your-server:port ./test-role-apis.sh
BASE_URL=http://your-server:port ./test-room-apis.sh
BASE_URL=http://your-server:port ./test-bed-apis.sh
BASE_URL=http://your-server:port ./test-care-level-apis.sh
BASE_URL=http://your-server:port ./test-elder-apis.sh
```

### 3. 查看结果

测试脚本会输出详细的测试结果，包括：
- ✅ 通过的测试
- ❌ 失败的测试
- ⚠️ 警告信息
- 📊 最终统计报告

## 📚 测试内容

### 👥 用户API专项测试脚本

除了完整的测试套件，我们还提供了专门针对用户管理功能的测试脚本 `test-user-apis.sh`。

#### 运行用户API测试

```bash
./test-user-apis.sh
```

#### 用户API测试覆盖的功能

1. **用户认证流程**
   - 管理员登录获取JWT token
   - Token有效性验证

2. **用户管理CRUD操作**
   - 获取用户列表（支持分页和筛选）
   - 根据ID获取单个用户信息
   - 创建新用户
   - 更新用户信息
   - 启用/禁用用户状态

3. **权限控制测试**
   - 无token访问保护
   - 无效token拒绝访问
   - 角色权限验证

4. **数据完整性验证**
   - 请求参数验证
   - 响应格式检查
   - 错误处理测试

#### 测试脚本特性

- 🔄 **自动登录**：脚本自动执行管理员登录并获取token
- 🎯 **完整流程**：从认证到CRUD操作的完整测试流程
- 📊 **详细报告**：彩色输出，包含测试统计和错误详情
- 🛡️ **权限验证**：测试各种权限控制场景

### 🔐 角色API专项测试脚本

除了完整的测试套件和用户API测试，我们还提供了专门针对角色管理功能的测试脚本 `test-role-apis.sh`。

#### 运行角色API测试

```bash
./test-role-apis.sh
```

#### 角色API测试覆盖的功能

1. **用户认证流程**
   - 管理员登录获取JWT token
   - Token有效性验证

2. **角色管理CRUD操作**
   - 获取角色列表（支持分页和筛选）
   - 根据ID获取单个角色信息
   - 创建新角色
   - 更新角色信息
   - 删除角色

3. **权限控制测试**
   - 无token访问保护
   - 无效token拒绝访问
   - 角色权限验证

4. **数据完整性验证**
   - 请求参数验证
   - 响应格式检查
   - 错误处理测试

#### 测试脚本特性

- 🔄 **自动登录**：脚本自动执行管理员登录并获取token
- 🎯 **完整流程**：从认证到CRUD操作的完整测试流程
- 📊 **详细报告**：彩色输出，包含测试统计和错误详情
- 🛡️ **权限验证**：测试各种权限控制场景
- 🔒 **系统保护**：防止删除系统管理员角色

#### 常见问题及解决方案

**问题1: 角色API返回403 Forbidden**
```
原因：用户角色权限未正确加载
解决方案：确保UserPrincipal.create方法能正确设置用户权限
```

**问题2: 中文搜索参数返回400错误**
```
原因：URL未对中文参数进行编码
解决方案：使用URL编码，如管理员 -> %E7%AE%A1%E7%90%86%E5%91%98
```

### 🏠 房间API专项测试脚本

除了完整的测试套件和用户/角色API测试，我们还提供了专门针对房间管理功能的测试脚本 `test-room-apis.sh`。

#### 运行房间API测试

```bash
./test-room-apis.sh
```

#### 房间API测试覆盖的功能

1. **用户认证流程**
   - 管理员登录获取JWT token
   - Token有效性验证

2. **房间管理CRUD操作**
   - 获取房间列表（支持分页和筛选）
   - 根据ID获取单个房间信息
   - 创建新房间
   - 更新房间信息
   - 删除房间

3. **高级查询功能**
   - 按房间号搜索
   - 按房间类型搜索
   - 按楼层筛选
   - 按最大床位数筛选

4. **权限控制测试**
   - 系统管理员、院长、前台接待员可以查看房间
   - 系统管理员和院长可以管理房间
   - 无权限访问保护

#### 测试脚本特性

- 🔄 **自动登录**：脚本自动执行管理员登录并获取token
- 🎯 **完整流程**：从认证到CRUD操作的完整测试流程
- 📊 **详细报告**：彩色输出，包含测试统计和错误详情
- 🏢 **设施管理**：测试养老院房间管理的所有功能

### 🛏️ 床位API专项测试脚本

除了完整的测试套件和用户/角色/房间API测试，我们还提供了专门针对床位管理功能的测试脚本 `test-bed-apis.sh`。

#### 运行床位API测试

```bash
./test-bed-apis.sh
```

#### 床位API测试覆盖的功能

1. **用户认证流程**
   - 管理员登录获取JWT token
   - Token有效性验证

2. **床位管理CRUD操作**
   - 获取床位列表（支持分页和多条件筛选）
   - 根据ID获取单个床位信息
   - 获取指定房间的所有床位
   - 获取所有空闲床位和指定房间的空闲床位
   - 创建新床位
   - 更新床位信息和状态
   - 删除床位（带保护机制）

3. **床位状态管理**
   - 设为空闲状态
   - 设为已入住状态
   - 设为维修状态
   - 状态查询和筛选

4. **高级查询功能**
   - 按房间ID筛选
   - 按床位号搜索
   - 按状态筛选（空闲/已入住/维修）
   - 分页查询支持

5. **权限控制测试**
   - 系统管理员、院长、前台接待员、护理主管可以查看床位
   - 系统管理员、院长可以管理床位
   - 护理主管可以更新床位状态
   - 无权限访问保护

#### 测试脚本特性

- 🔄 **自动登录**：脚本自动执行管理员登录并获取token
- 🎯 **完整流程**：从认证到CRUD操作的完整测试流程
- 📊 **详细报告**：彩色输出，包含测试统计和错误详情
- 🛏️ **床位管理**：测试养老院床位管理的所有功能
- 🛡️ **业务保护**：防止删除正在使用的床位

### 🏥 护理等级API专项测试脚本

除了完整的测试套件和用户/角色/房间/床位API测试，我们还提供了专门针对护理等级管理功能的测试脚本 `test-care-level-apis.sh`。

#### 运行护理等级API测试

```bash
./test-care-level-apis.sh
```

#### 护理等级API测试覆盖的功能

1. **用户认证流程**
   - 管理员登录获取JWT token
   - Token有效性验证

2. **护理等级管理CRUD操作**
   - 获取护理等级列表（支持分页和多条件筛选）
   - 获取所有护理等级（不分页，用于下拉框等）
   - 根据编码获取单个护理等级信息
   - 根据价格范围筛选护理等级
   - 创建新护理等级
   - 更新护理等级信息
   - 删除护理等级

3. **高级查询功能**
   - 按等级编码搜索
   - 按等级名称搜索
   - 按描述搜索
   - 按价格范围筛选（最低价、最高价）
   - 分页查询支持

4. **权限控制测试**
   - 系统管理员、院长、护理主管、财务人员可以查看护理等级
   - 系统管理员、院长可以管理护理等级
   - 无权限访问保护

#### 测试脚本特性

- 🔄 **自动登录**：脚本自动执行管理员登录并获取token
- 🎯 **完整流程**：从认证到CRUD操作的完整测试流程
- 📊 **详细报告**：彩色输出，包含测试统计和错误详情
- 🏥 **护理管理**：测试养老院护理等级管理的所有功能
- 💰 **费用管理**：支持按价格范围查询，为费用计算提供基础

### 💰 费用项目API专项测试脚本

除了完整的测试套件和用户/角色/房间/床位/护理等级API测试，我们还提供了专门针对费用项目管理功能的测试脚本 `test-fee-item-apis.sh`。

#### 运行费用项目API测试

```bash
./test-fee-item-apis.sh
```

#### 费用项目API测试覆盖的功能

1. **用户认证流程**
   - 管理员登录获取JWT token
   - Token有效性验证

2. **费用项目管理CRUD操作**
   - 获取费用项目列表（支持分页和多条件筛选）
   - 根据代码获取单个费用项目信息
   - 根据类型获取费用项目列表
   - 创建新费用项目
   - 更新费用项目信息
   - 删除费用项目

3. **高级查询功能**
   - 按项目代码搜索
   - 按项目名称搜索
   - 按项目类型搜索
   - 根据类型筛选费用项目
   - 分页查询支持

4. **权限控制测试**
   - 系统管理员、财务人员可以管理费用项目（增删改）
   - 系统管理员、财务人员、前台接待可以查看费用项目
   - 无权限访问保护

#### 测试脚本特性

- 🔄 **自动登录**：脚本自动执行管理员登录并获取token
- 🎯 **完整流程**：从认证到CRUD操作的完整测试流程
- 📊 **详细报告**：彩色输出，包含测试统计和错误详情
- 💰 **财务管理**：测试养老院费用项目管理的所有功能
- 🔒 **权限控制**：验证不同角色的访问权限

### 🔐 认证接口测试
- **POST /api/auth/login** - 用户登录
- **POST /api/auth/register** - 用户注册

### 👥 用户管理接口测试
- **GET /api/users** - 获取用户列表（分页）
- **GET /api/users/{id}** - 获取用户信息
- **POST /api/users** - 创建用户
- **PUT /api/users/{id}** - 更新用户
- **DELETE /api/users/{id}** - 删除用户

### 🔐 角色管理接口测试
- **GET /api/roles** - 获取角色列表（分页）
- **GET /api/roles/{id}** - 获取角色信息
- **POST /api/roles** - 创建角色
- **PUT /api/roles/{id}** - 更新角色
- **DELETE /api/roles/{id}** - 删除角色

### 🏠 房间管理接口测试
- **GET /api/rooms** - 获取房间列表（分页）
- **GET /api/rooms/{id}** - 获取房间信息
- **POST /api/rooms** - 创建房间
- **PUT /api/rooms/{id}** - 更新房间
- **DELETE /api/rooms/{id}** - 删除房间

### 🛏️ 床位管理接口测试
- **GET /api/beds** - 获取床位列表（分页）
- **GET /api/beds/{id}** - 获取床位信息
- **GET /api/beds/room/{roomId}** - 获取房间的所有床位
- **GET /api/beds/available** - 获取所有空闲床位
- **GET /api/beds/available/room/{roomId}** - 获取房间的空闲床位
- **POST /api/beds** - 创建床位
- **PUT /api/beds/{id}** - 更新床位信息
- **PUT /api/beds/{id}/available** - 设为空闲
- **PUT /api/beds/{id}/occupied** - 设为已入住
- **PUT /api/beds/{id}/maintenance** - 设为维修
- **DELETE /api/beds/{id}** - 删除床位

### 🏥 护理等级管理接口测试
- **GET /api/care-levels** - 获取护理等级列表（分页）
- **GET /api/care-levels/all** - 获取所有护理等级（不分页）
- **GET /api/care-levels/{levelCode}** - 获取护理等级信息
- **GET /api/care-levels/price-range** - 根据价格范围获取护理等级
- **POST /api/care-levels** - 创建护理等级
- **PUT /api/care-levels/{levelCode}** - 更新护理等级信息
- **DELETE /api/care-levels/{levelCode}** - 删除护理等级

### 🧓 老人档案管理接口测试
- **GET /api/elders** - 获取老人列表（分页）
- **GET /api/elders/{id}** - 获取老人信息
- **POST /api/elders** - 创建老人档案
- **PUT /api/elders/{id}** - 更新老人档案
- **DELETE /api/elders/{id}** - 删除老人档案

### 🔒 权限测试
- 无权限访问控制
- 404错误处理

### 📊 数据完整性测试
- 响应格式验证
- 分页数据结构检查

### ⚡ 性能测试
- 接口响应时间测量

## 🎯 测试用例说明

### 默认测试账户
```
用户名: admin
密码: 123456
角色: 系统管理员
```

### 测试流程
1. **环境检查** - 验证依赖和服务器连接
2. **认证测试** - 登录获取token
3. **业务接口测试** - 使用token测试所有业务接口
4. **权限测试** - 验证访问控制
5. **数据验证** - 检查响应格式和数据完整性
6. **性能测试** - 测量响应时间

## 📋 测试输出示例

```
🚀 开始养老院管理系统完整API测试
目标服务器: http://localhost:8080
开始时间: Wed Dec 24 15:16:00 CST 2025

================================================
检查依赖
================================================
✅ 依赖检查完成

================================================
测试服务器连接
================================================
✅ 服务器连接正常

🔐 认证接口测试
================================================
测试管理员登录
响应状态: 200
响应内容: {"code":200,"message":"操作成功","data":{"token":"...","id":1,...}}
✅ 管理员登录成功，获取到 token

测试错误凭据登录
✅ 错误凭据登录正确被拒绝

👥 用户管理接口测试
================================================
测试 1: 获取用户列表
请求: GET http://localhost:8080/api/users
响应状态: 200
✅ 获取用户列表 - 成功

📋 测试报告
================================================
总测试数: 15
✅ 通过: 13
❌ 失败: 0
⚠️  警告: 2
成功率: 86%

🎉 所有核心功能测试通过！API 系统运行正常。
```

## 🔧 故障排除

### 常见问题

#### 1. 连接失败
```
❌ 无法连接到服务器 http://localhost:8080
```
**解决方案**：
- 检查后端服务是否启动：`mvn spring-boot:run`
- 检查端口是否被占用：`lsof -i :8080`
- 检查防火墙设置

#### 2. 数据库连接失败
```
Communications link failure
```
**解决方案**：
- 确保MySQL服务运行：`brew services start mysql`
- 检查数据库是否存在：`mysql -u root -p -e "SHOW DATABASES;"`
- 验证连接配置

#### 3. 权限不足
```
❌ 无权限访问未被拒绝
```
**解决方案**：
- 检查JWT token是否正确
- 验证用户角色权限
- 检查Security配置

#### 4. 依赖缺失
```
curl 未安装
```
**解决方案**：
- macOS: `brew install curl`
- Ubuntu: `sudo apt install curl`
- CentOS: `sudo yum install curl`

### 调试模式

启用详细日志：
```bash
# 后端启用DEBUG日志
logging.level.com.elderlycare.management: DEBUG

# 测试脚本启用详细输出
bash -x ./test-complete-api.sh
```

## 📊 测试覆盖率

| 模块 | 接口数量 | 测试状态 |
|------|---------|----------|
| 认证 | 2 | ✅ 完全覆盖 |
| 用户管理 | 7 | ✅ 完全覆盖 |
| 权限控制 | 2 | ✅ 完全覆盖 |
| 数据验证 | 3 | ✅ 完全覆盖 |
| 性能测试 | 1 | ✅ 完全覆盖 |

## 🎨 自定义配置

### 修改服务器地址
```bash
# 编辑脚本中的BASE_URL变量
BASE_URL="http://your-server:port"
```

### 添加新测试用例
```bash
# 在test_user_endpoints()函数中添加新的test_api调用
test_api "METHOD" "/path" "data" "headers" "description"
```

### 修改测试账户
```bash
# 编辑脚本中的登录凭据
local login_data='{"username":"your-user","password":"your-pass"}'
```

## 📞 支持

如果遇到问题，请：
1. 检查测试输出中的错误信息
2. 查看后端日志：`tail -f logs/spring.log`
3. 验证数据库连接
4. 检查网络配置

## 🔄 更新日志

- **v1.0.0** - 初始版本，包含认证和用户管理接口测试
- 支持分页查询、CRUD操作、权限控制
- 包含性能测试和数据验证
- 彩色输出和详细报告